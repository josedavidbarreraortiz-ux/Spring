<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="layouts/admin-layout :: layout(~{::title}, ~{::content})">

<head>
    <title>Nueva Venta</title>
</head>

<body>

    <section th:fragment="content">

        <h2 class="mb-3"><i class="bi bi-cart-plus me-2"></i>Registrar Venta</h2>

        <form method="post" th:action="@{/admin/ventas/guardar}" th:object="${venta}" id="ventaForm">

            <div class="row">
                <!-- Columna izquierda: Datos de la venta -->
                <div class="col-lg-5">
                    <!-- Datos del comprador -->
                    <div class="card shadow-sm mb-3">
                        <div class="card-header bg-primary text-white">
                            <i class="bi bi-person-fill me-2"></i>Datos del Cliente
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Usuario <span class="text-danger">*</span></label>
                                <select name="userId" id="selectUsuario" class="form-select" required
                                    onchange="actualizarDatosUsuario()">
                                    <option value="">Seleccione un usuario</option>
                                    <option th:each="u : ${usuarios}" th:value="${u.id}"
                                        th:text="${u.name + ' - ' + u.email}" th:data-nombre="${u.name}"
                                        th:data-email="${u.email}">
                                    </option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Nombre Completo <span class="text-danger">*</span></label>
                                <input type="text" name="clienteNombre" id="clienteNombre" class="form-control" required
                                    placeholder="Nombre del cliente" data-validate="required|minLength:2|maxLength:100">
                                <div class="invalid-feedback"></div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Teléfono <span class="text-danger">*</span></label>
                                <input type="tel" name="clienteTelefono" class="form-control" required
                                    placeholder="Ej: 3001234567" data-validate="required|phone10">
                                <div class="invalid-feedback"></div>
                                <small class="text-muted">Debe tener exactamente 10 dígitos</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Dirección de Envío <span class="text-danger">*</span></label>
                                <input type="text" name="clienteDireccion" class="form-control" required
                                    placeholder="Ej: Calle 123 #45-67, Barrio Centro" data-validate="required|address">
                                <div class="invalid-feedback"></div>
                                <small class="text-muted">Más de 5 caracteres y al menos 1 número</small>
                            </div>

                            <hr>

                            <div class="mb-3">
                                <label class="form-label">Método de Pago <span class="text-danger">*</span></label>
                                <select name="metodoPago.metodoPagoId" class="form-select" required>
                                    <option value="">Seleccione método de pago</option>
                                    <option th:each="m : ${metodosPago}" th:value="${m.metodoPagoId}"
                                        th:text="${m.metodoPagoNombre}"></option>
                                </select>
                            </div>

                            <div class="row">
                                <div class="col-6">
                                    <label class="form-label">Fecha</label>
                                    <input type="date" th:field="*{ventaFecha}" class="form-control" readonly>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Hora</label>
                                    <input type="time" th:field="*{ventaHora}" class="form-control" readonly>
                                </div>
                            </div>
                            <small class="text-muted"><i class="bi bi-info-circle"></i> Fecha y hora automáticas</small>

                            <div class="mt-3">
                                <label class="form-label">Observaciones</label>
                                <textarea th:field="*{observaciones}" class="form-control" rows="2"
                                    placeholder="Opcional..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Resumen del total -->
                    <div class="card shadow-sm bg-success text-white">
                        <div class="card-body text-center">
                            <h5 class="mb-1"><i class="bi bi-cash-coin me-2"></i>Total de la Venta</h5>
                            <h2 class="mb-0" id="totalVenta">$0.00</h2>
                            <small id="cantidadProductos">0 productos</small>
                        </div>
                    </div>
                </div>

                <!-- Columna derecha: Productos -->
                <div class="col-lg-7">
                    <div class="card shadow-sm">
                        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-box-seam me-2"></i>Productos</span>
                            <button type="button" class="btn btn-light btn-sm" onclick="agregarProducto()">
                                <i class="bi bi-plus-circle"></i> Agregar Producto
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="productosContainer">
                                <!-- Productos dinámicos -->
                                <div class="producto-row mb-3 p-3 border rounded bg-light" data-index="0">
                                    <div class="row align-items-end">
                                        <div class="col-md-6 mb-2">
                                            <label class="form-label">Producto</label>
                                            <select name="productoIds" class="form-select producto-select"
                                                onchange="actualizarPrecio(this)">
                                                <option value="">Seleccione un producto</option>
                                                <option th:each="p : ${productos}" th:value="${p.productoId}"
                                                    th:text="${p.productoNombre + ' - $' + p.productoPrecioVenta}"
                                                    th:data-precio="${p.productoPrecioVenta}">
                                                </option>
                                            </select>
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label">Cantidad</label>
                                            <input type="number" name="cantidades" class="form-control cantidad-input"
                                                value="1" min="1" onchange="calcularTotal()">
                                        </div>
                                        <div class="col-md-2 mb-2">
                                            <label class="form-label">Subtotal</label>
                                            <input type="text" class="form-control subtotal-display" readonly
                                                value="$0.00">
                                        </div>
                                        <div class="col-md-1 mb-2">
                                            <button type="button" class="btn btn-outline-danger btn-sm"
                                                onclick="eliminarProducto(this)" title="Eliminar">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="alert alert-warning mt-3" id="alertaVacia">
                                <i class="bi bi-exclamation-triangle"></i> Agregue al menos un producto para registrar
                                la venta
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-4 d-flex gap-2">
                <button type="submit" class="btn btn-success btn-lg" id="btnGuardar" disabled>
                    <i class="bi bi-check-circle me-2"></i>Registrar Venta
                </button>
                <a th:href="@{/admin/ventas}" class="btn btn-secondary btn-lg">
                    <i class="bi bi-x-circle me-2"></i>Cancelar
                </a>
            </div>

        </form>

        <script th:inline="javascript">
            let productoIndex = 1;

            function actualizarDatosUsuario() {
                const select = document.getElementById('selectUsuario');
                const selectedOption = select.options[select.selectedIndex];
                const nombre = selectedOption.getAttribute('data-nombre') || '';

                document.getElementById('clienteNombre').value = nombre;
            }

            function agregarProducto() {
                const container = document.getElementById('productosContainer');
                const template = container.querySelector('.producto-row').cloneNode(true);

                template.setAttribute('data-index', productoIndex);
                template.querySelector('.producto-select').value = '';
                template.querySelector('.cantidad-input').value = 1;
                template.querySelector('.subtotal-display').value = '$0.00';

                container.appendChild(template);
                productoIndex++;
                actualizarAlerta();
            }

            function eliminarProducto(btn) {
                const rows = document.querySelectorAll('.producto-row');
                if (rows.length > 1) {
                    btn.closest('.producto-row').remove();
                    calcularTotal();
                } else {
                    const row = btn.closest('.producto-row');
                    row.querySelector('.producto-select').value = '';
                    row.querySelector('.cantidad-input').value = 1;
                    row.querySelector('.subtotal-display').value = '$0.00';
                    calcularTotal();
                }
            }

            function actualizarPrecio(selectElement) {
                const row = selectElement.closest('.producto-row');
                const selectedOption = selectElement.options[selectElement.selectedIndex];
                const precio = parseFloat(selectedOption.getAttribute('data-precio')) || 0;
                const cantidad = parseInt(row.querySelector('.cantidad-input').value) || 1;
                const subtotal = precio * cantidad;

                row.querySelector('.subtotal-display').value = '$' + subtotal.toFixed(2);
                calcularTotal();
            }

            function calcularTotal() {
                let total = 0;
                let cantidadProductos = 0;

                document.querySelectorAll('.producto-row').forEach(row => {
                    const select = row.querySelector('.producto-select');
                    const cantidadInput = row.querySelector('.cantidad-input');
                    const subtotalDisplay = row.querySelector('.subtotal-display');

                    if (select.value) {
                        const selectedOption = select.options[select.selectedIndex];
                        const precio = parseFloat(selectedOption.getAttribute('data-precio')) || 0;
                        const cantidad = parseInt(cantidadInput.value) || 1;
                        const subtotal = precio * cantidad;

                        subtotalDisplay.value = '$' + subtotal.toFixed(2);
                        total += subtotal;
                        cantidadProductos++;
                    } else {
                        subtotalDisplay.value = '$0.00';
                    }
                });

                document.getElementById('totalVenta').textContent = '$' + total.toFixed(2);
                document.getElementById('cantidadProductos').textContent = cantidadProductos + ' producto(s)';

                actualizarAlerta();
            }

            function actualizarAlerta() {
                let tieneProducto = false;
                document.querySelectorAll('.producto-select').forEach(select => {
                    if (select.value) tieneProducto = true;
                });

                document.getElementById('alertaVacia').style.display = tieneProducto ? 'none' : 'block';
                document.getElementById('btnGuardar').disabled = !tieneProducto;
            }

            document.addEventListener('DOMContentLoaded', function () {
                actualizarAlerta();

                document.getElementById('ventaForm').addEventListener('submit', function (e) {
                    let tieneProducto = false;
                    document.querySelectorAll('.producto-select').forEach(select => {
                        if (select.value) tieneProducto = true;
                    });

                    if (!tieneProducto) {
                        e.preventDefault();
                        alert('Debe seleccionar al menos un producto');
                    }
                });
            });
        </script>

    </section>

</body>

</html>