<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Sesión / Registrarse - FH</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/login-style.css}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
</head>

<body>
    <div class="form-container">
        <h2 id="formTitle" class="form-title">Iniciar Sesión</h2>

        <!-- Error Messages -->
        <div th:if="${error}" class="alert alert-danger">
            <i class="bi bi-exclamation-circle"></i>
            <span th:text="${error}">Error</span>
        </div>

        <!-- Success Messages -->
        <div th:if="${message}" class="alert alert-success">
            <i class="bi bi-check-circle"></i>
            <span th:text="${message}">Mensaje</span>
        </div>

        <!-- Login Form -->
        <form id="loginForm" th:action="@{/login}" method="post" style="display: block;">
            <div class="input-group">
                <label for="loginEmail">
                    <i class="bi bi-envelope"></i> Correo Electrónico
                </label>
                <input type="email" id="loginEmail" name="username" placeholder="Correo" required>
            </div>

            <div class="input-group">
                <label for="loginPassword">
                    <i class="bi bi-lock"></i> Contraseña
                </label>
                <input type="password" id="loginPassword" name="password" placeholder="Contraseña" required>
            </div>

            <button type="submit" class="submit-btn">
                <i class="bi bi-box-arrow-in-right"></i> Ingresar
            </button>
        </form>

        <!-- Register Form -->
        <form id="registerForm" th:action="@{/register}" method="post" style="display: none;">
            <div class="input-group">
                <label for="registerName">
                    <i class="bi bi-person"></i> Nombre
                </label>
                <input type="text" id="registerName" name="name" placeholder="Nombre" required minlength="3">
                <small class="validation-message" id="nameValidation"></small>
            </div>

            <div class="input-group">
                <label for="registerEmail">
                    <i class="bi bi-envelope"></i> Correo Electrónico
                </label>
                <input type="email" id="registerEmail" name="email" placeholder="Correo" required>
                <small class="validation-message" id="emailValidation"></small>
            </div>

            <div class="input-group">
                <label for="registerPassword">
                    <i class="bi bi-lock"></i> Contraseña
                </label>
                <input type="password" id="registerPassword" name="password" placeholder="Contraseña" required
                    minlength="8">
                <small class="validation-message" id="passwordValidation"></small>
                <!-- Password Strength Indicator -->
                <div class="password-strength" id="passwordStrength" style="display: none;">
                    <div class="strength-bar">
                        <div class="strength-fill" id="strengthFill"></div>
                    </div>
                    <span class="strength-text" id="strengthText"></span>
                </div>
                <!-- Password Requirements -->
                <div class="password-requirements" id="passwordRequirements">
                    <small><i class="bi bi-info-circle"></i> La contraseña debe contener:</small>
                    <ul>
                        <li id="req-length"><i class="bi bi-x-circle"></i> Al menos 8 caracteres</li>
                        <li id="req-uppercase"><i class="bi bi-x-circle"></i> Una letra mayúscula</li>
                        <li id="req-lowercase"><i class="bi bi-x-circle"></i> Una letra minúscula</li>
                        <li id="req-number"><i class="bi bi-x-circle"></i> Un número</li>
                        <li id="req-special"><i class="bi bi-x-circle"></i> Un carácter especial (!@_#$%^&*)</li>
                    </ul>
                </div>
            </div>

            <div class="input-group">
                <label for="registerPasswordConfirm">
                    <i class="bi bi-lock-fill"></i> Confirmar Contraseña
                </label>
                <input type="password" id="registerPasswordConfirm" name="password_confirmation"
                    placeholder="Confirmar contraseña" required>
                <small class="validation-message" id="passwordConfirmValidation"></small>
            </div>

            <button type="submit" class="submit-btn">
                <i class="bi bi-person-plus"></i> Registrarse
            </button>
        </form>

        <!-- Toggle Button -->
        <div class="text-center mt-4">
            <p style="color: #6b7280; font-size: 0.9rem;">
                <span id="toggleText">¿No tienes cuenta?</span>
                <a href="#" id="toggleBtn" class="text-link">Regístrate aquí</a>
            </p>
        </div>

    </div>

    <script>
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const formTitle = document.getElementById('formTitle');
        const toggleBtn = document.getElementById('toggleBtn');
        const toggleText = document.getElementById('toggleText');
        const testCredentials = document.getElementById('testCredentials');

        // Form elements
        const registerName = document.getElementById('registerName');
        const registerEmail = document.getElementById('registerEmail');
        const registerPassword = document.getElementById('registerPassword');
        const registerPasswordConfirm = document.getElementById('registerPasswordConfirm');

        // Validation message elements
        const nameValidation = document.getElementById('nameValidation');
        const emailValidation = document.getElementById('emailValidation');
        const passwordValidation = document.getElementById('passwordValidation');
        const passwordConfirmValidation = document.getElementById('passwordConfirmValidation');

        // Password strength elements
        const passwordStrength = document.getElementById('passwordStrength');
        const strengthFill = document.getElementById('strengthFill');
        const strengthText = document.getElementById('strengthText');
        const passwordRequirements = document.getElementById('passwordRequirements');

        // Toggle between login and register forms
        toggleBtn.addEventListener('click', function (e) {
            e.preventDefault();

            if (loginForm.style.display === 'none') {
                // Show login
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                formTitle.textContent = 'Iniciar Sesión';
                toggleText.textContent = '¿No tienes cuenta?';
                toggleBtn.textContent = 'Regístrate aquí';
                if (testCredentials) testCredentials.style.display = 'block';
            } else {
                // Show register
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                formTitle.textContent = 'Registrarse';
                toggleText.textContent = '¿Ya tienes cuenta?';
                toggleBtn.textContent = 'Inicia sesión aquí';
                if (testCredentials) testCredentials.style.display = 'none';
            }
        });

        // Validation functions
        function showValidationMessage(element, message, isValid) {
            element.textContent = message;
            element.style.color = isValid ? '#10b981' : '#ef4444';
            element.style.display = message ? 'block' : 'none';
        }

        function validateName() {
            const name = registerName.value.trim();
            // Solo permite letras (incluyendo acentos) y espacios - NO números
            const nameRegex = /^[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s]+$/;

            if (name.length === 0) {
                showValidationMessage(nameValidation, '', false);
                return false;
            } else if (name.length < 3) {
                showValidationMessage(nameValidation, 'El nombre debe tener al menos 3 caracteres', false);
                return false;
            } else if (!nameRegex.test(name)) {
                showValidationMessage(nameValidation, 'El nombre solo puede contener letras y espacios', false);
                return false;
            } else {
                showValidationMessage(nameValidation, '✓ Nombre válido', true);
                return true;
            }
        }

        function validateEmail() {
            // Limpiar espacios al inicio y al final
            const email = registerEmail.value.trim();
            // Actualizar el valor del campo sin espacios
            registerEmail.value = email;

            // El email no debe contener espacios en ninguna parte
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (email.length === 0) {
                showValidationMessage(emailValidation, '', false);
                return false;
            } else if (email.includes(' ')) {
                showValidationMessage(emailValidation, 'El correo no puede contener espacios', false);
                return false;
            } else if (!emailRegex.test(email)) {
                showValidationMessage(emailValidation, 'Por favor ingresa un correo válido', false);
                return false;
            } else {
                showValidationMessage(emailValidation, '✓ Correo válido', true);
                return true;
            }
        }

        function checkPasswordRequirement(requirementId, condition) {
            const element = document.getElementById(requirementId);
            if (condition) {
                element.classList.add('valid');
                element.querySelector('i').className = 'bi bi-check-circle';
            } else {
                element.classList.remove('valid');
                element.querySelector('i').className = 'bi bi-x-circle';
            }
            return condition;
        }

        function calculatePasswordStrength(password) {
            let strength = 0;
            const checks = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /[0-9]/.test(password),
                special: /[!@#$%^&*(),._?":{}|<>]/.test(password)
            };

            // Update requirement indicators
            checkPasswordRequirement('req-length', checks.length);
            checkPasswordRequirement('req-uppercase', checks.uppercase);
            checkPasswordRequirement('req-lowercase', checks.lowercase);
            checkPasswordRequirement('req-number', checks.number);
            checkPasswordRequirement('req-special', checks.special);

            // Calculate strength score
            Object.values(checks).forEach(check => {
                if (check) strength++;
            });

            return { strength, checks };
        }

        function updatePasswordStrength() {
            const password = registerPassword.value;

            if (password.length === 0) {
                passwordStrength.style.display = 'none';
                passwordRequirements.style.display = 'none';
                showValidationMessage(passwordValidation, '', false);
                return false;
            }

            passwordStrength.style.display = 'block';
            passwordRequirements.style.display = 'block';

            const { strength, checks } = calculatePasswordStrength(password);
            const percentage = (strength / 5) * 100;

            strengthFill.style.width = percentage + '%';

            // Update strength bar color and text
            if (strength <= 2) {
                strengthFill.style.backgroundColor = '#ef4444';
                strengthText.textContent = 'Débil';
                strengthText.style.color = '#ef4444';
            } else if (strength === 3) {
                strengthFill.style.backgroundColor = '#f59e0b';
                strengthText.textContent = 'Media';
                strengthText.style.color = '#f59e0b';
            } else if (strength === 4) {
                strengthFill.style.backgroundColor = '#3b82f6';
                strengthText.textContent = 'Buena';
                strengthText.style.color = '#3b82f6';
            } else {
                strengthFill.style.backgroundColor = '#10b981';
                strengthText.textContent = 'Excelente';
                strengthText.style.color = '#10b981';
            }

            // Check if all requirements are met
            const allValid = Object.values(checks).every(check => check);
            if (allValid) {
                showValidationMessage(passwordValidation, '✓ Contraseña segura', true);
                return true;
            } else {
                showValidationMessage(passwordValidation, '', false);
                return false;
            }
        }

        function validatePasswordConfirm() {
            const password = registerPassword.value;
            const confirmPassword = registerPasswordConfirm.value;

            if (confirmPassword.length === 0) {
                showValidationMessage(passwordConfirmValidation, '', false);
                return false;
            } else if (password !== confirmPassword) {
                showValidationMessage(passwordConfirmValidation, 'Las contraseñas no coinciden', false);
                return false;
            } else {
                showValidationMessage(passwordConfirmValidation, '✓ Las contraseñas coinciden', true);
                return true;
            }
        }

        // Event listeners for real-time validation
        registerName.addEventListener('input', validateName);
        registerName.addEventListener('blur', validateName);

        registerEmail.addEventListener('input', validateEmail);
        registerEmail.addEventListener('blur', validateEmail);

        registerPassword.addEventListener('input', updatePasswordStrength);
        registerPassword.addEventListener('blur', updatePasswordStrength);

        registerPasswordConfirm.addEventListener('input', validatePasswordConfirm);
        registerPasswordConfirm.addEventListener('blur', validatePasswordConfirm);

        // Trim email on login form too
        document.getElementById('loginEmail').addEventListener('blur', function () {
            this.value = this.value.trim();
        });

        // Form submission validation
        registerForm.addEventListener('submit', function (e) {
            // Trim name and email before submitting
            registerName.value = registerName.value.trim();
            registerEmail.value = registerEmail.value.trim();

            const isNameValid = validateName();
            const isEmailValid = validateEmail();
            const isPasswordValid = updatePasswordStrength();
            const isPasswordConfirmValid = validatePasswordConfirm();

            if (!isNameValid || !isEmailValid || !isPasswordValid || !isPasswordConfirmValid) {
                e.preventDefault();

                // Scroll to first invalid field
                if (!isNameValid) registerName.focus();
                else if (!isEmailValid) registerEmail.focus();
                else if (!isPasswordValid) registerPassword.focus();
                else if (!isPasswordConfirmValid) registerPasswordConfirm.focus();
            }
        });

        // Trim email on login submit
        loginForm.addEventListener('submit', function () {
            document.getElementById('loginEmail').value = document.getElementById('loginEmail').value.trim();
        });
    </script>
</body>

</html>